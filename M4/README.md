# M4

## Functional fragment of LNLD. 

## Typing rules

### Type Formation
```
                                             Γ ⊢ e : Uᵢ        Γ ⊢ e : Lᵢ
-------------         --------------        ------------       ------------
Γ ⊢ Uᵢ : Uᵢ₊₁         Γ ⊢ Lᵢ : Uᵢ₊₁         Γ ⊢ e type        Γ ⊢ e linear


Γ ⊢ X : Uᵢ  Γ ⊢ e : X  Γ ⊢ e' : X
----------------------------------
       Γ ⊢ e =ₓ e' : Uᵢ


Γ ⊢ X : Uᵢ  Γ,x:X ⊢ Y : Uᵢ      Γ ⊢ X : Uᵢ  Γ,x:X ⊢ A : Lᵢ     Γ ⊢ A : Lᵢ  Γ ⊢ B : Lᵢ
---------------------------     ---------------------------     -----------------------
     Γ ⊢ Πx:X.Y : Uᵢ                  Γ ⊢ Πx:X.A : Lᵢ               Γ ⊢ A ⊸ B : Lᵢ


Γ ⊢ X : Uᵢ  Γ,x:X ⊢ Y : Uᵢ      Γ ⊢ A : Lᵢ  Γ ⊢ B : Lᵢ       Γ ⊢ A : Lᵢ  Γ ⊢ B : Lᵢ
---------------------------     ------------------------      -----------------------
      Γ ⊢ Σx:X.Y : Uᵢ                Γ ⊢ A ⊗ B : Lᵢ               Γ ⊢ A & B : Lᵢ


----------     ----------     -----------
Γ ⊢ 1 : Uᵢ     Γ ⊢ I : Lᵢ     Γ ⊢ ⊤ : Lᵢ


 Γ ⊢ A : Lᵢ      Γ ⊢ X : Uᵢ  Γ,x:X ⊢ A : Lᵢ
------------     ---------------------------
Γ ⊢ G A : Uᵢ          Γ ⊢ Fx:X.A : Lᵢ
```

### Intuitionistic Typing
The elimination rule for intensional =ₓ is omitted, refer to HoTT book for details.
```
                         Γ ⊢ e : Y    Γ ⊢ X ≡ Y type
-----------------        ----------------------------
Γ,x:X,Γ' ⊢ x : X                 Γ ⊢ e : X


Γ ⊢ e : X    Γ ⊢ e' : [e/x]Y      Γ ⊢ e : Σx:X.Y        Γ ⊢ e : Σx:X.Y
-----------------------------     ---------------     ---------------------
    Γ ⊢ (e, e') : Σx:X.Y           Γ ⊢ π₁ e : X       Γ ⊢ π₂ e : [π₁ e/x]Y


Γ ⊢ Πx:X.Y type    Γ,x:X Γ e : Y       Γ ⊢ e : Πx:X.Y    Γ ⊢ e' : X
---------------------------------      ------------------------------
     Γ ⊢ λx.e : Πx.X.Y                     Γ ⊢ e e' : [e'/x]Y


Γ ⊢ e ≡ e' : X            Γ;⋅ ⊢ e : A
------------------       --------------       -----------
Γ ⊢ refl : e =ₓ e'       Γ ⊢ G e : G A        Γ ⊢ () : 1
```

### Linear Typing
```
                        Γ;Δ ⊢ e : B     Γ ⊢ A ≡ B linear
--------------          ---------------------------------
Γ;a:A ⊢ a : A                     Γ;Δ ⊢ e : A


Γ;Δ ⊢ e : I    Γ;Δ' ⊢ e' : C
------------------------------
Γ;Δ,Δ' ⊢ let () = e in e' : C


Γ;Δ ⊢ e : A    Γ;Δ' ⊢ e' : B       Γ;Δ ⊢ e : A ⊗ B   Γ;Δ',a:A,b:B ⊢ e' : C
-----------------------------      ----------------------------------------
   Γ;Δ,Δ' ⊢ (e, e') : A ⊗ B           Γ;Δ,Δ' ⊢ let (a, b) = e in e' : C


Γ;Δ ⊢ e₁ : A₁   Γ;Δ ⊢ e₂ : A₂      Γ;Δ ⊢ e : A & B       Γ;Δ ⊢ e : A & B
------------------------------     -----------------      ----------------
Γ;Δ ⊢ (e₁, e₂) : A₁ & A₂            Γ;Δ ⊢ π₁ e : A        Γ;Δ ⊢ π₂ e : B


Γ;Δ,a:A ⊢ e : B          Γ;Δ ⊢ e : A ⊸ B   Γ;Δ' ⊢ e' : A
-------------------      ----------------------------------
Γ;Δ ⊢ λa.e : A ⊸ B              Γ;Δ,Δ' ⊢ e e' : B


Γ,x:X;Δ ⊢ e : A          Γ;Δ ⊢ e : Πx:X.A    Γ ⊢ e' : X
--------------------     -------------------------------
Γ;Δ ⊢ λ̂x.e : Πx:X.A           Γ;Δ ⊢ e e' : [e'/x]A


Γ ⊢ e : X   Γ;Δ ⊢ t : [e/x]A     Γ;Δ ⊢ e : Fx:X.A    Γ,x:X;Δ',a:A ⊢ e' : C
-----------------------------    -------------------------------------------
  Γ;Δ ⊢ F (e, t) : Fx:X.A            Γ;Δ,Δ' ⊢ let F (x, a) = e in e' : C


Γ ⊢ e : G A
----------------      -------------      -------------
Γ;⋅ ⊢ G⁻¹ e : A       Γ;⋅ ⊢ () : I       Γ;Δ ⊢ () : ⊤
```

## Shortcomings
The type system is quite bulky, requiring F and G to map between modalities. 
This adds complexity to extending with user defined data types.

## Planned Changes

### Type Formation
```
                                      Γ ⊢ e : Uᵢ      Γ ⊢ e : Lᵢ
-------------     --------------     ------------     ------------
Γ ⊢ Uᵢ : Uᵢ₊₁     Γ ⊢ Lᵢ : Uᵢ₊₁      Γ ⊢ e type      Γ ⊢ e linear


Γ ⊢ e : Uᵢ
-----------
Γ ⊢ e : Lᵢ


Γ ⊢ X : Uᵢ  Γ ⊢ e : X  Γ ⊢ e' : X
----------------------------------
       Γ ⊢ e =ₓ e' : Uᵢ


Γ ⊢ X : Uᵢ  Γ,x:X ⊢ Y : Uᵢ      Γ ⊢ X : Uᵢ  Γ,x:X ⊢ A : Lᵢ     Γ ⊢ A : Lᵢ  Γ ⊢ B : Lᵢ
---------------------------     ---------------------------     -----------------------
     Γ ⊢ Πx:X.Y : Uᵢ                  Γ ⊢ Πx:X.A : Lᵢ               Γ ⊢ A ⊸ B : Lᵢ


Γ ⊢ X : Uᵢ  Γ,x:X ⊢ Y : Uᵢ      Γ ⊢ A : Lᵢ  Γ ⊢ B : Lᵢ       Γ ⊢ A : Lᵢ  Γ ⊢ B : Lᵢ
---------------------------     ------------------------      -----------------------
      Γ ⊢ Σx:X.Y : Uᵢ                Γ ⊢ A ⊗ B : Lᵢ               Γ ⊢ A & B : Lᵢ


----------     ----------     -----------
Γ ⊢ 1 : Uᵢ     Γ ⊢ I : Lᵢ     Γ ⊢ ⊤ : Lᵢ


 Γ ⊢ A : Lᵢ
------------
Γ ⊢ ! A : Uᵢ
```

### Intuitionistic Typing
```
                         Γ ⊢ e : Y    Γ ⊢ X ≡ Y type
-----------------        ----------------------------
Γ,x:X,Γ' ⊢ x : X                 Γ ⊢ e : X


Γ ⊢ e : X    Γ ⊢ e' : [e/x]Y      Γ ⊢ e : Σx:X.Y        Γ ⊢ e : Σx:X.Y
-----------------------------     ---------------     ---------------------
    Γ ⊢ (e, e') : Σx:X.Y           Γ ⊢ π₁ e : X       Γ ⊢ π₂ e : [π₁ e/x]Y


Γ ⊢ Πx:X.Y type    Γ,x:X Γ e : Y       Γ ⊢ e : Πx:X.Y    Γ ⊢ e' : X
---------------------------------      ------------------------------
     Γ ⊢ λx.e : Πx.X.Y                     Γ ⊢ e e' : [e'/x]Y


Γ ⊢ e ≡ e' : X            Γ;⋅ ⊢ e : A
------------------       --------------       -----------
Γ ⊢ refl : e =ₓ e'       Γ ⊢ ! e : ! A        Γ ⊢ () : 1
```

### Linear Typing
```
                        Γ;Δ ⊢ e : B     Γ ⊢ A ≡ B linear
--------------          ---------------------------------
Γ;a:A ⊢ a : A                     Γ;Δ ⊢ e : A


Γ;Δ ⊢ e : I    Γ;Δ' ⊢ e' : C
------------------------------
Γ;Δ,Δ' ⊢ let () = e in e' : C


Γ;Δ ⊢ e : A    Γ;Δ' ⊢ e' : B       Γ;Δ ⊢ e : A ⊗ B   Γ;Δ',a:A,b:B ⊢ e' : C
-----------------------------      ----------------------------------------
   Γ;Δ,Δ' ⊢ (e, e') : A ⊗ B           Γ;Δ,Δ' ⊢ let (a, b) = e in e' : C


Γ;Δ ⊢ e₁ : A₁   Γ;Δ ⊢ e₂ : A₂      Γ;Δ ⊢ e : A & B       Γ;Δ ⊢ e : A & B
------------------------------     -----------------      ----------------
Γ;Δ ⊢ (e₁, e₂) : A₁ & A₂            Γ;Δ ⊢ π₁ e : A        Γ;Δ ⊢ π₂ e : B


Γ;Δ,a:A ⊢ e : B          Γ;Δ ⊢ e : A ⊸ B   Γ;Δ' ⊢ e' : A
-------------------      ----------------------------------
Γ;Δ ⊢ λa.e : A ⊸ B              Γ;Δ,Δ' ⊢ e e' : B


Γ,x:X;Δ ⊢ e : A          Γ;Δ ⊢ e : Πx:X.A    Γ ⊢ e' : X
--------------------     -------------------------------
Γ;Δ ⊢ λ̂x.e : Πx:X.A           Γ;Δ ⊢ e e' : [e'/x]A


 Γ ⊢ e : ! A
--------------      -------------      -------------
Γ;⋅ ⊢ ¡ e : A       Γ;⋅ ⊢ () : I       Γ;Δ ⊢ () : ⊤
```

## References
* https://homotopytypetheory.org/book/
* https://www.cs.cmu.edu/~fp/courses/15816-f01/handouts/linfp.pdf
* https://dl.acm.org/doi/10.1145/2775051.2676969
* https://gist.github.com/gabriel-barrett/0de85a606b64886052854422fb05ce0c
* https://gist.github.com/gabriel-barrett/11988a272bc52f0e848db6eceb03417a
* https://richarde.dev/papers/2020/quantitative/quantitative.pdf
* https://www.type-driven.org.uk/edwinb/papers/idris2.pdf
* https://bentnib.org/quantitative-type-theory.pdf
* https://link.springer.com/chapter/10.1007/978-3-319-30936-1_12